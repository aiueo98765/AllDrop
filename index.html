<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ALL Drop - ファイル共有を即座に</title>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@300;400;500;600&family=Zen+Kaku+Gothic+New:wght@300;400;500&display=swap" rel="stylesheet">

    <style>
        :root {
            --bg-main: #0f1218;
            --panel-bg: rgba(30, 35, 45, 0.75);
            --accent-blue: #3a86ff;
            --accent-hover: #2766cc;
            --text-primary: #ffffff;
            --text-secondary: #a0a5b0;
            --border-light: rgba(255, 255, 255, 0.1);
            --success: #2ecc71;
            --error: #e74c3c;
            --font-en: 'Montserrat', sans-serif;
            --font-jp: 'Zen Kaku Gothic New', sans-serif;
        }
        body {
            background-color: var(--bg-main);
            background-image: radial-gradient(circle at top right, rgba(58, 134, 255, 0.15), transparent 70%),
                              radial-gradient(circle at bottom left, rgba(15, 18, 24, 1), transparent 70%);
            color: var(--text-primary);
            font-family: var(--font-jp);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            margin: 0;
            letter-spacing: 0.05em;
        }

        .en { font-family: var(--font-en); }
        h1 { font-family: var(--font-en); font-weight: 300; font-size: 2.4rem; margin-bottom: 0.2em; letter-spacing: 2px; text-transform: uppercase; }
        .subtitle { font-size: 0.85em; color: var(--text-secondary); font-weight: 400; margin-bottom: 45px; opacity: 0.8; }
        
        .container {
            width: 90%;
            max-width: 480px;
            background: var(--panel-bg);
            backdrop-filter: blur(25px) saturate(150%);
            padding: 40px;
            border-radius: 16px;
            border: 1px solid var(--border-light);
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.4);
        }

        .signal-meter { display: flex; align-items: flex-end; justify-content: space-between; height: 45px; margin: 30px 0; border-bottom: 1px solid var(--border-light); padding-bottom: 8px; }
        .signal-bar { width: 3px; height: 3px; background: var(--text-secondary); opacity: 0.3; border-radius: 3px; transition: all 0.15s ease-out; }

        button {
            background: rgba(255, 255, 255, 0.05); border: 1px solid var(--border-light); color: var(--accent-blue);
            padding: 18px; width: 100%; font-family: var(--font-jp); font-weight: 500; font-size: 0.95rem; letter-spacing: 0.1em;
            cursor: pointer; margin-bottom: 15px; transition: all 0.3s ease; border-radius: 8px;
            position: relative; overflow: hidden; display: flex; justify-content: center; align-items: center; gap: 10px;
        }
        button span.sub { font-size: 0.8em; opacity: 0.7; font-family: var(--font-en); font-weight: 400; }
        button:hover:not(:disabled) { background: var(--accent-blue); color: white; border-color: var(--accent-blue); box-shadow: 0 8px 20px rgba(58, 134, 255, 0.3); transform: translateY(-1px); }
        button:disabled { background: rgba(0, 0, 0, 0.2); border-color: transparent; color: rgba(255, 255, 255, 0.25); cursor: not-allowed; box-shadow: none; }
        
        /* Textarea for Text Sending */
        textarea {
            width: 100%;
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid var(--border-light);
            border-radius: 8px;
            color: var(--text-primary);
            padding: 15px;
            font-family: var(--font-jp);
            font-size: 0.9rem;
            resize: none;
            height: 80px;
            margin-bottom: 15px;
            box-sizing: border-box;
            outline: none;
            transition: border 0.3s;
        }
        textarea:focus { border-color: var(--accent-blue); }
        textarea::placeholder { color: rgba(255, 255, 255, 0.3); }

        /* Receiver Text Output */
        #receivedTextContainer {
            margin-top: 20px;
            background: rgba(58, 134, 255, 0.1);
            border-left: 3px solid var(--accent-blue);
            padding: 15px;
            border-radius: 0 8px 8px 0;
            display: none;
            text-align: left;
        }
        #receivedTextLabel { font-size: 0.75em; color: var(--accent-blue); margin-bottom: 5px; font-family: var(--font-en); letter-spacing: 1px; }
        #receivedTextContent { font-size: 0.95rem; line-height: 1.5; white-space: pre-wrap; word-break: break-all; }

        .mode-switch { display: flex; gap: 20px; margin-bottom: 35px; border-bottom: 1px solid var(--border-light); padding-bottom: 5px;}
        .mode-switch button { background: transparent; border: none; border-radius: 0; color: var(--text-secondary); padding: 10px 5px; margin: 0; width: auto; font-weight: 400; display: inline-block; }
        .mode-switch button::after { content: ''; position: absolute; bottom: -6px; left: 0; width: 100%; height: 2px; background: var(--accent-blue); transform: scaleX(0); transition: transform 0.3s; }
        .mode-switch button.active-mode { color: var(--text-primary); font-weight: 500; box-shadow: none; transform: none;}
        .mode-switch button.active-mode::after { transform: scaleX(1); }
        .mode-switch button:hover:not(.active-mode) { background: transparent; color: var(--text-primary); box-shadow: none; transform: none;}

        #statusText { text-align: center; margin-bottom: 25px; font-weight: 400; color: var(--text-primary); min-height: 1.4em; font-size: 0.9em; }
        
        #log { font-size: 0.75em; color: var(--text-secondary); height: 100px; overflow-y: auto; background: rgba(0,0,0,0.15); padding: 15px; margin-top: 30px; border-radius: 8px; border: 1px solid var(--border-light); line-height: 1.6; font-family: var(--font-en); }
        .log-entry { margin: 4px 0; }
        .success { color: var(--success); }
        .error { color: var(--error); }
        .sys { font-style: italic; opacity: 0.7; }

        #rxProgressBg { height: 4px; background: rgba(255,255,255,0.1); width: 100%; margin-top: 15px; border-radius: 4px; overflow: hidden; }
        #rxProgress { height: 100%; background: var(--accent-blue); width: 0%; transition: width 0.1s; border-radius: 4px; box-shadow: 0 0 10px rgba(58, 134, 255, 0.5); }
        #fileInput { display: none; }
        #fileInfo { text-align: center; margin-bottom: 15px; font-size: 0.85em; color: var(--text-secondary); font-weight: 400;}
    </style>
</head>
<body>

    <h1>Sonic Drop</h1>
    <div class="subtitle">音響データ転送 (High Gain Ver) v3.4</div>

    <div class="container">
        <div class="mode-switch">
            <button id="btnSenderMode" class="active-mode" onclick="setMode('sender')">送信 <span class="en sub">SENDER</span></button>
            <button id="btnReceiverMode" onclick="setMode('receiver')">受信 <span class="en sub">RECEIVER</span></button>
        </div>

        <div class="signal-meter" id="signalMeter"></div>
        <div id="statusText">待機中。モードを選択してください。</div>

        <div id="senderUI">
            <button onclick="document.getElementById('fileInput').click()">
                ファイルを選択 <span class="sub">SELECT FILE</span>
            </button>
            <input type="file" id="fileInput">
            <div id="fileInfo">ファイルなし</div>
            
            <textarea id="textInput" placeholder="テキストメッセージを入力 (任意)"></textarea>

            <button id="btnTransmit">
                送信開始 <span class="sub">TRANSMIT</span>
            </button>
        </div>

        <div id="receiverUI" style="display:none;">
            <button id="btnListen">
                受信待機 <span class="sub">START LISTENING</span>
            </button>
             <div id="rxProgressBg"><div id="rxProgress"></div></div>
             
             <div id="receivedTextContainer">
                 <div id="receivedTextLabel">RECEIVED MESSAGE</div>
                 <div id="receivedTextContent"></div>
             </div>
        </div>

        <div id="log">
            <div class="log-entry sys">System initialized. Gain boosted (300%).</div>
        </div>
    </div>

<script>
/**
 * SONIC DROP v3.4 - High Gain & Text Support
 * ==========================================
 * - Audio Gain increased to 2.4 (Approx 3x standard)
 * - Added text message support alongside file transfer
 */

const CONFIG = {
    baseFreq: 18200, step: 100, duration: 250,
    startMarker: 17800, endMarker: 17800,
    threshold: -60, hexMap: "0123456789ABCDEF"
};

let audioCtx, analyser, microphone, peer, conn;
let isRunning = false;
let currentMode = 'sender';

const logs = document.getElementById('log');
const meterDiv = document.getElementById('signalMeter');
const bars = [];
for(let i=0; i<16; i++) {
    let b = document.createElement('div'); b.className = 'signal-bar';
    meterDiv.appendChild(b); bars.push(b);
}

function log(msg, type='') {
    const div = document.createElement('div');
    div.className = 'log-entry ' + type;
    div.innerText = msg;
    logs.prepend(div);
}

function setStatus(msg, isError=false) {
    const el = document.getElementById('statusText');
    el.innerText = msg;
    el.style.color = isError ? 'var(--error)' : 'var(--text-primary)';
}

function setMode(mode) {
    currentMode = mode;
    document.getElementById('senderUI').style.display = mode === 'sender' ? 'block' : 'none';
    document.getElementById('receiverUI').style.display = mode === 'receiver' ? 'block' : 'none';
    
    const btns = document.querySelectorAll('.mode-switch button');
    btns.forEach(b => b.classList.remove('active-mode'));
    if(mode === 'sender') document.getElementById('btnSenderMode').classList.add('active-mode');
    else document.getElementById('btnReceiverMode').classList.add('active-mode');
    
    resetConnection();
    stopAudio();
    setStatus(mode === 'sender' ? "送信モード: 準備完了" : "受信モード: 準備完了");
    
    // Reset UI specific
    document.getElementById('receivedTextContainer').style.display = 'none';
}

function resetConnection() {
    if(conn) { conn.close(); conn = null; }
    if(peer) { peer.destroy(); peer = null; }
}

// --- AUDIO CORE (HIGH GAIN) ---
function initAudio() {
    if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    if (audioCtx.state === 'suspended') audioCtx.resume();
}

async function playTone(freq, duration) {
    const osc = audioCtx.createOscillator();
    const gain = audioCtx.createGain();
    osc.frequency.value = freq; osc.type = 'sine';
    osc.connect(gain); gain.connect(audioCtx.destination);
    
    // 【変更点】 ゲインを 0.8 -> 2.4 にブースト (3倍)
    const VOLUME_BOOST = 2.4; 
    
    gain.gain.setValueAtTime(0, audioCtx.currentTime);
    gain.gain.linearRampToValueAtTime(VOLUME_BOOST, audioCtx.currentTime + 0.02);
    gain.gain.linearRampToValueAtTime(0, audioCtx.currentTime + (duration/1000) - 0.02);
    
    osc.start();
    return new Promise(r => setTimeout(() => { osc.stop(); r(); }, duration));
}

// --- TRANSMITTER ---
async function transmitSequence(token) {
    const file = document.getElementById('fileInput').files[0];
    const text = document.getElementById('textInput').value;

    if(!file && !text) {
        setStatus("ファイルまたはテキストを入力してください", true);
        return;
    }

    const btn = document.getElementById('btnTransmit');
    btn.disabled = true;
    btn.innerHTML = `送信中... <span class="sub">SENDING</span>`;
    setStatus("音波トークンを送信中 (High Power)...");

    resetConnection();
    initAudio();
    const checksum = CONFIG.hexMap[token.split('').reduce((a,c)=>a+c.charCodeAt(0),0)%16];
    const payload = token + checksum;
    log(`Token: ${token} [CS:${checksum}] (Gain: 300%)`, 'sys');

    await playTone(CONFIG.startMarker, CONFIG.duration * 1.5);
    for (let char of payload) {
        const freq = CONFIG.baseFreq + (CONFIG.hexMap.indexOf(char) * CONFIG.step);
        const bar = bars[CONFIG.hexMap.indexOf(char)];
        bar.style.height = '100%'; bar.style.background = 'var(--accent-blue)'; bar.style.opacity = '1';
        setTimeout(() => { bar.style.height = '3px'; bar.style.background = 'var(--text-secondary)'; bar.style.opacity = '0.3'; }, 200);
        await playTone(freq, CONFIG.duration);
    }
    await playTone(CONFIG.endMarker, CONFIG.duration);
    
    setStatus("音波送信完了。データ転送準備中...");
    initPeerHost(token, file, text);
}

function resetSenderState() {
    const btn = document.getElementById('btnTransmit');
    btn.disabled = false;
    btn.innerHTML = `送信開始 <span class="sub">TRANSMIT</span>`;
    setStatus("送信完了。続けて送信可能です。");
    setTimeout(() => { resetConnection(); }, 2000);
}

// --- RECEIVER ---
async function startListening() {
    initAudio();
    resetConnection();
    try {
        const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
        microphone = audioCtx.createMediaStreamSource(stream);
        analyser = audioCtx.createAnalyser(); analyser.fftSize = 4096;
        microphone.connect(analyser);
        isRunning = true;
        
        const btn = document.getElementById('btnListen');
        btn.disabled = true;
        btn.innerHTML = `解析中... <span class="sub">SCANNING</span>`;
        setStatus("信号を検索中 (18kHz帯)...");
        document.getElementById('receivedTextContainer').style.display = 'none'; // Reset text view
        
        analyzeLoop();
    } catch(e) { log("Mic Error", "error"); setStatus("マイクエラー", true); }
}

let rxState='IDLE', rxBuffer="", lastCharTime=0;
function analyzeLoop() {
    if(!isRunning) return;
    const data = new Float32Array(analyser.frequencyBinCount);
    analyser.getFloatFrequencyData(data);
    let maxVal=-Infinity, maxIndex=-1;
    const binWidth = audioCtx.sampleRate / analyser.fftSize;
    for(let i=Math.floor(17500/binWidth); i<Math.floor(20500/binWidth); i++) {
        if(data[i]>maxVal) { maxVal=data[i]; maxIndex=i; }
    }

    if(maxVal > CONFIG.threshold) {
        const freq = maxIndex * binWidth;
        const now = Date.now();
        document.getElementById('rxProgress').style.width = Math.min(100, (maxVal+80)*2.5) + "%";

        let char = null;
        if(Math.abs(freq-CONFIG.startMarker)<50) char='START';
        else {
            for(let i=0; i<16; i++) if(Math.abs(freq-(CONFIG.baseFreq+i*CONFIG.step))<45) char=CONFIG.hexMap[i];
        }

        if (char && (now - lastCharTime > CONFIG.duration*0.7)) {
            if (char === 'START') {
                rxState = 'RECEIVING'; rxBuffer = ""; lastCharTime = now;
                setStatus("信号検知。データ受信中...");
                log("START Marker Detected", 'success');
            } else if (rxState === 'RECEIVING' && CONFIG.hexMap.includes(char)) {
                rxBuffer += char; lastCharTime = now;
                const idx = CONFIG.hexMap.indexOf(char);
                bars[idx].style.height = '100%'; bars[idx].style.background = 'var(--accent-blue)'; bars[idx].style.opacity = '1';
                setTimeout(()=>{bars[idx].style.height='3px'; bars[idx].style.background = 'var(--text-secondary)'; bars[idx].style.opacity = '0.3';}, 200);
                if(rxBuffer.length===5) { validateAndConnect(rxBuffer); rxState='IDLE'; rxBuffer=""; }
            }
        }
    } else { document.getElementById('rxProgress').style.width = "0%"; }
    requestAnimationFrame(analyzeLoop);
}

function stopAudio() { 
    isRunning = false; 
    if(microphone) microphone.disconnect(); 
    const btn = document.getElementById('btnListen');
    btn.disabled=false; 
    btn.innerHTML = `受信待機 <span class="sub">START LISTENING</span>`;
}

function validateAndConnect(buf) {
    const token=buf.substr(0,4), sum=buf.substr(4,1);
    const calc=CONFIG.hexMap[token.split('').reduce((a,c)=>a+c.charCodeAt(0),0)%16];
    if(sum===calc) {
        log(`Checksum OK (${token}). Connecting...`, 'success');
        setStatus("認証成功。接続中...");
        stopAudio(); connectPeer(token);
    } else {
        log(`Checksum Error. Retrying...`, 'error');
        setStatus("再スキャン中...", true);
    }
}

// --- WEBRTC P2P & DATA TRANSFER ---
function initPeerHost(token, file, text) {
    peer = new Peer("sonic-v3-" + token);
    peer.on('connection', c => {
        conn = c; log("Peer Connected.", 'success');
        conn.on('open', () => {
            setStatus("接続確立。データ送信中...");
            
            // データ送信ペイロードの構築
            const payload = {};
            let infoMsg = "";
            
            if (file) {
                payload.file = file;
                payload.filename = file.name;
                payload.filetype = file.type;
                infoMsg += `File: ${file.name} `;
            }
            if (text) {
                payload.text = text;
                infoMsg += `Text: ${text.length} chars`;
            }

            conn.send(payload);
            log(`Sent: ${infoMsg}`, 'success');
            
            // 完了処理
            resetSenderState();
        });
    });
    peer.on('error', e => { log("P2P Error: "+e, 'error'); resetSenderState(); });
}

function connectPeer(token) {
    peer = new Peer();
    peer.on('open', () => {
        conn = peer.connect("sonic-v3-" + token);
        conn.on('open', () => setStatus("接続確立。データ待機中..."));
        conn.on('data', d => {
            log("Data Packet Received.", 'success');
            setStatus("データ受信完了。");

            // 1. ファイル処理
            if(d.file) {
                log(`File: ${d.filename}`, 'success');
                const a = document.createElement('a');
                a.href = URL.createObjectURL(new Blob([d.file],{type:d.filetype}));
                a.download = d.filename; a.click();
            }

            // 2. テキスト処理
            if(d.text) {
                log("Text Message Received.", 'success');
                const txtBox = document.getElementById('receivedTextContainer');
                const txtContent = document.getElementById('receivedTextContent');
                txtContent.textContent = d.text;
                txtBox.style.display = 'block';
            }

            // 次の受信待機へ
            setTimeout(() => {
                setStatus("受信待機に戻るにはボタンを押してください。");
                resetConnection();
            }, 3000);
        });
    });
    peer.on('error', () => { log("Connect Failed. Retrying...", 'error'); startListening(); });
}

// --- EVENTS ---
document.getElementById('fileInput').addEventListener('change', (e) => {
    const f = e.target.files[0];
    if(f) document.getElementById('fileInfo').innerText = `${f.name} (${(f.size/1024).toFixed(1)}KB)`;
    else document.getElementById('fileInfo').innerText = "ファイルなし";
});

document.getElementById('btnTransmit').addEventListener('click', () => {
    // 毎回新しいトークン
    const token = Array.from({length:4},()=>CONFIG.hexMap[Math.floor(Math.random()*16)]).join('');
    transmitSequence(token);
});
document.getElementById('btnListen').addEventListener('click', startListening);

</script>
</body>
</html>